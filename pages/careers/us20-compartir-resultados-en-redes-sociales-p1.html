<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Compartir resultados del test vocacional">
  <title>Compartir Resultados - Vocatio</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../../css/styles-compartir.css">
<body>
  <div class="header" style="display:flex; justify-content:space-between; align-items:center; background:linear-gradient(135deg,#693efe 0%,#8b7aff 100%); padding:20px 40px; color:white; margin-bottom:20px;">
    <div class="logo" style="color:white;">vocatio</div>
    <nav style="display:flex; gap:30px; justify-content:center; flex:1;">
      <a href="./explore.html" style="color:rgba(255,255,255,0.9); text-decoration:none; font-size:16px; transition:color 0.3s;">Explorar carreras</a>
      <a href="#" style="color:rgba(255,255,255,0.9); text-decoration:none; font-size:16px; transition:color 0.3s;">Eventos</a>
      <a href="#" style="color:rgba(255,255,255,0.9); text-decoration:none; font-size:16px; transition:color 0.3s;">Test vocacional</a>
      <a href="./progreso.complete.html" style="color:rgba(255,255,255,0.9); text-decoration:none; font-size:16px; transition:color 0.3s;">Progreso</a>
    </nav>
  </div>
  <div class="container">
    <div class="header-card">
      <div class="header-left">
        <div class="logo">vocatio</div>
      </div>
      <div class="header-center">
        <h1 class="title">Mis Resultados</h1>
        <p class="subtitle">Resultados de tu test vocacional completado</p>
      </div>
    </div>

    <div class="results-section">
      <div class="results-header">
        <h2 class="results-title">Test Vocacional Completado</h2>
        <p class="results-date" id="dateInfo">Realizado el â€”</p>
      </div>

      <h3 class="section-subtitle">Tus Ãreas de InterÃ©s Principales</h3>
      
      <div class="results-grid">
        <div class="result-item">
          <div class="result-emoji">ğŸ’»</div>
          <div class="result-name">TecnologÃ­a</div>
          <div class="result-percentage" id="affinity-tecnologia">â€”%</div>
          <div class="progress-bar">
            <div class="progress-fill" id="progress-tecnologia" style="width: 0%"></div>
          </div>
        </div>
        <div class="result-item">
          <div class="result-emoji">ğŸ”¬</div>
          <div class="result-name">Ciencias</div>
          <div class="result-percentage" id="affinity-ciencias">â€”%</div>
          <div class="progress-bar">
            <div class="progress-fill" id="progress-ciencias" style="width: 0%"></div>
          </div>
        </div>
        <div class="result-item">
          <div class="result-emoji">ğŸ¨</div>
          <div class="result-name">Arte</div>
          <div class="result-percentage" id="affinity-arte">â€”%</div>
          <div class="progress-bar">
            <div class="progress-fill" id="progress-arte" style="width: 0%"></div>
          </div>
        </div>
        <div class="result-item">
          <div class="result-emoji">ğŸ’¼</div>
          <div class="result-name">Negocios</div>
          <div class="result-percentage" id="affinity-negocios">â€”%</div>
          <div class="progress-bar">
            <div class="progress-fill" id="progress-negocios" style="width: 0%"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="two-column-layout">
      <div class="main-content">
        <div class="recommendations-card">
          <h3 class="recommendations-title">Carreras Recomendadas (8)</h3>
          <div id="recommendation-source" class="recommendation-source" style="font-size:13px;color:#67666f;margin-bottom:8px"></div>
          <ul class="careers-list" id="recommended-list">
            <!-- Se rellenarÃ¡ dinÃ¡micamente -->
          </ul>
        </div>
      </div>

      <div class="sidebar">
        <div class="customize-card">
          <h2 class="customize-title">âœ¨ Personalizar</h2>
          <div class="form-group">
            <label class="form-label">TÃ­tulo personalizado</label>
            <input type="text" class="form-input" id="customTitle" placeholder="Ej: Â¡DescubrÃ­ mi vocaciÃ³n!">
          </div>
          <div class="form-group">
            <label class="form-label">Mensaje personalizado</label>
            <textarea class="form-textarea" id="customMessage" placeholder="Agrega un mensaje personal para compartir..."></textarea>
          </div>
          <div class="form-group">
            <label class="form-label">Tema de color</label>
            <select class="form-select" id="colorTheme">
              <option value="purple">Morado (Predeterminado)</option>
              <option value="blue">Azul</option>
              <option value="green">Verde</option>
              <option value="orange">Naranja</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Mostrar fecha</label>
            <select class="form-select" id="showDate">
              <option value="yes">SÃ­</option>
              <option value="no">No</option>
            </select>
          </div>
          <button class="preview-btn" id="previewBtn">ğŸ‘ï¸ Vista Previa</button>
        </div>

        <div class="share-card">
          <h3 class="share-title">Compartir Resultados</h3>
          <p class="share-subtitle">Inspira a otros compartiÃ©ndo tu experiencia en Vocatio</p>
          <div class="social-buttons">
          <a href="#" class="social-btn" id="facebookBtn">ğŸ“˜ Facebook</a>
          <a href="#" class="social-btn" id="twitterBtn">ğŸ¦ Twitter</a>
          <a href="#" class="social-btn" id="linkedinBtn">ğŸ’¼ LinkedIn</a>
          <a href="#" class="social-btn" id="instagramBtn">ğŸ“· Instagram</a>
          <button class="social-btn download-btn" id="downloadBtn">â¬‡ï¸ Descargar</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" id="previewModal">
    <div class="modal-content">
      <button class="modal-close" id="closeModal">Ã—</button>
      <h2 class="preview-title">Vista Previa para Compartir</h2>
      <div id="previewContainer"></div>
      <p style="text-align:center;color:#8b8a92;margin-top:15px;">Esta es la vista previa de cÃ³mo se verÃ¡ tu publicaciÃ³n</p>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script>
    const themes = {
      purple:{primary:'#693efe',secondary:'#7e7af7',light:'#f9f8ff',border:'#d9d4ff'},
      blue:{primary:'#2563eb',secondary:'#3b82f6',light:'#eff6ff',border:'#bfdbfe'},
      green:{primary:'#059669',secondary:'#10b981',light:'#f0fdf4',border:'#bbf7d0'},
      orange:{primary:'#ea580c',secondary:'#f97316',light:'#fff7ed',border:'#fed7aa'},
      pink:{primary:'#db2777',secondary:'#ec4899',light:'#fdf2f8',border:'#fbcfe8'}
    };

    let currentTheme='purple',customTitle='',customMessage='',showDate=true;

    function applyTheme(theme){
      const colors=themes[theme];
      document.querySelectorAll('.result-item').forEach(item=>{item.style.backgroundColor=colors.light;item.style.borderColor=colors.border});
      document.querySelectorAll('.result-name').forEach(name=>name.style.color=colors.primary);
      document.querySelectorAll('.result-percentage').forEach(p=>p.style.color=colors.secondary);
      document.querySelector('.logo').style.color=colors.primary;
      document.querySelectorAll('.preview-btn,.download-btn').forEach(btn=>btn.style.backgroundColor=colors.primary);
    }

    document.getElementById('colorTheme').addEventListener('change',function(e){currentTheme=e.target.value;applyTheme(currentTheme)});
    document.getElementById('showDate').addEventListener('change',function(e){showDate=e.target.value==='yes';document.getElementById('dateInfo').style.display=showDate?'block':'none'});
    document.getElementById('previewBtn').addEventListener('click',function(){customTitle=document.getElementById('customTitle').value;customMessage=document.getElementById('customMessage').value;generatePreview()});

    function generatePreview(){
      const previewContainer=document.getElementById('previewContainer');const colors=themes[currentTheme];
      const previewCard=document.createElement('div');previewCard.style.cssText='background:#fff;border-radius:20px;padding:40px;box-shadow:0 10px 30px rgba(105,62,254,0.1)';
      const logoEl=document.createElement('div');logoEl.textContent='vocatio';logoEl.style.cssText=`font-size:42px;font-weight:700;color:${colors.primary};margin-bottom:20px;text-align:center`;previewCard.appendChild(logoEl);
      const titleEl=document.createElement('h2');titleEl.textContent=customTitle||'Â¡DescubrÃ­ mi vocaciÃ³n!';titleEl.style.cssText='font-size:28px;font-weight:700;color:#1b1b1b;margin-bottom:15px;text-align:center';previewCard.appendChild(titleEl);
      const resultsGrid=document.createElement('div');resultsGrid.style.cssText='display:grid;grid-template-columns:repeat(2,1fr);gap:15px;margin:25px 0';
      const results=[{emoji:'ğŸ’»',name:'TecnologÃ­a',percentage:document.getElementById('affinity-tecnologia').textContent},{emoji:'ğŸ”¬',name:'Ciencias',percentage:document.getElementById('affinity-ciencias').textContent},{emoji:'ğŸ¨',name:'Arte',percentage:document.getElementById('affinity-arte').textContent},{emoji:'ğŸ’¼',name:'Negocios',percentage:document.getElementById('affinity-negocios').textContent}];
      results.forEach(result=>{const item=document.createElement('div');item.style.cssText=`background:${colors.light};border:3px solid ${colors.border};border-radius:15px;padding:20px;text-align:center`;item.innerHTML=`<div style="font-size:40px;margin-bottom:8px;">${result.emoji}</div><div style="font-size:20px;font-weight:700;color:${colors.primary};margin-bottom:5px;">${result.name}</div><div style="font-size:14px;color:${colors.secondary};">${result.percentage}</div>`;resultsGrid.appendChild(item)});
      previewCard.appendChild(resultsGrid);
      if(showDate){const dateEl=document.createElement('div');dateEl.textContent=document.getElementById('dateInfo').textContent;dateEl.style.cssText=`text-align:center;color:${colors.secondary};font-size:14px;margin-top:15px;padding-top:15px;border-top:2px solid ${colors.border}`;previewCard.appendChild(dateEl)}
      if(customMessage){const messageEl=document.createElement('p');messageEl.textContent=customMessage;messageEl.style.cssText='font-size:16px;color:#67666f;margin-top:20px;text-align:center;line-height:1.6;padding:15px;background:#f9f8ff;border-radius:10px';previewCard.appendChild(messageEl)}
      const hashtagsEl=document.createElement('div');hashtagsEl.textContent='#Vocatio #TestVocacional #MiVocaciÃ³n';hashtagsEl.style.cssText=`text-align:center;color:${colors.primary};font-size:14px;margin-top:20px;font-weight:600`;previewCard.appendChild(hashtagsEl);
      previewContainer.innerHTML='';previewContainer.appendChild(previewCard);document.getElementById('previewModal').classList.add('active')}

    document.getElementById('closeModal').addEventListener('click',function(){document.getElementById('previewModal').classList.remove('active')});
    document.getElementById('previewModal').addEventListener('click',function(e){if(e.target===this)this.classList.remove('active')});

    function getShareUrl(network){const pageUrl=encodeURIComponent(window.location.href);const title=customTitle||'Â¡Mira mis resultados del test vocacional!';const message=customMessage||'DescubrÃ­ mis Ã¡reas de mayor afinidad vocacional';const text=encodeURIComponent(`${title} ${message} en Vocatio ğŸ’»ğŸ”¬ #Vocatio #TestVocacional`);switch(network){case'facebook':return`https://www.facebook.com/sharer/sharer.php?u=${pageUrl}`;case'twitter':return`https://twitter.com/intent/tweet?url=${pageUrl}&text=${text}`;case'linkedin':return`https://www.linkedin.com/sharing/share-offsite/?url=${pageUrl}`;default:return null}}

    document.getElementById('facebookBtn').addEventListener('click',function(e){e.preventDefault();const url=getShareUrl('facebook');if(url)window.open(url,'_blank','width=600,height=400')});
    document.getElementById('twitterBtn').addEventListener('click',function(e){e.preventDefault();const url=getShareUrl('twitter');if(url)window.open(url,'_blank','width=600,height=400')});
    document.getElementById('linkedinBtn').addEventListener('click',function(e){e.preventDefault();const url=getShareUrl('linkedin');if(url)window.open(url,'_blank','width=600,height=400')});
    document.getElementById('instagramBtn').addEventListener('click',function(e){e.preventDefault();alert('ğŸ’¡ Consejo: Usa el botÃ³n "Descargar" para guardar tu resultado y compartirlo en Instagram Stories o Feed')});

    document.getElementById('downloadBtn').addEventListener('click',async function(){this.textContent='â³ Generando...';this.disabled=true;try{const tempDiv=document.createElement('div');tempDiv.style.cssText='position:fixed;left:-9999px;top:0';document.body.appendChild(tempDiv);const colors=themes[currentTheme];const previewCard=document.createElement('div');previewCard.style.cssText=`background:#fff;width:1200px;padding:60px;font-family:'Inter',sans-serif`;const logoEl=document.createElement('div');logoEl.textContent='vocatio';logoEl.style.cssText=`font-size:52px;font-weight:700;color:${colors.primary};margin-bottom:25px;text-align:center`;previewCard.appendChild(logoEl);const titleEl=document.createElement('h2');titleEl.textContent=customTitle||'Â¡DescubrÃ­ mi vocaciÃ³n!';titleEl.style.cssText='font-size:36px;font-weight:700;color:#1b1b1b;margin-bottom:20px;text-align:center';previewCard.appendChild(titleEl);const resultsGrid=document.createElement('div');resultsGrid.style.cssText='display:grid;grid-template-columns:repeat(2,1fr);gap:20px;margin:30px 0';const results=[{emoji:'ğŸ’»',name:'TecnologÃ­a',percentage:document.getElementById('affinity-tecnologia').textContent},{emoji:'ğŸ”¬',name:'Ciencias',percentage:document.getElementById('affinity-ciencias').textContent},{emoji:'ğŸ¨',name:'Arte',percentage:document.getElementById('affinity-arte').textContent},{emoji:'ğŸ’¼',name:'Negocios',percentage:document.getElementById('affinity-negocios').textContent}];results.forEach(result=>{const item=document.createElement('div');item.style.cssText=`background:${colors.light};border:3px solid ${colors.border};border-radius:15px;padding:30px;text-align:center`;item.innerHTML=`<div style="font-size:52px;margin-bottom:10px">${result.emoji}</div><div style="font-size:26px;font-weight:700;color:${colors.primary};margin-bottom:8px">${result.name}</div><div style="font-size:18px;color:${colors.secondary}">${result.percentage}</div>`;resultsGrid.appendChild(item)});previewCard.appendChild(resultsGrid);if(showDate){const dateEl=document.createElement('div');dateEl.textContent=document.getElementById('dateInfo').textContent;dateEl.style.cssText=`text-align:center;color:${colors.secondary};font-size:16px;margin-top:20px;padding-top:20px;border-top:2px solid ${colors.border}`;previewCard.appendChild(dateEl)}if(customMessage){const messageEl=document.createElement('p');messageEl.textContent=customMessage;messageEl.style.cssText='font-size:18px;color:#67666f;margin-top:25px;text-align:center;line-height:1.6;padding:20px;background:#f9f8ff;border-radius:10px';previewCard.appendChild(messageEl)}const hashtagsEl=document.createElement('div');hashtagsEl.textContent='#Vocatio #TestVocacional #MiVocaciÃ³n';hashtagsEl.style.cssText=`text-align:center;color:${colors.primary};font-size:16px;margin-top:25px;font-weight:600`;previewCard.appendChild(hashtagsEl);tempDiv.appendChild(previewCard);const canvas=await html2canvas(previewCard,{backgroundColor:'#ffffff',scale:2,logging:false,width:1200});document.body.removeChild(tempDiv);const link=document.createElement('a');link.download='mis-resultados-vocatio.png';link.href=canvas.toDataURL('image/png');link.click();this.textContent='âœ… Â¡Descargado!';setTimeout(()=>{this.textContent='â¬‡ï¸ Descargar';this.disabled=false},2000)}catch(error){console.error('Error al generar imagen:',error);this.textContent='âŒ Error';setTimeout(()=>{this.textContent='â¬‡ï¸ Descargar';this.disabled=false},2000)}});

    // Cargar datos del test vocacional desde localStorage (versiÃ³n robusta y normalizada)
    function cargarDatosDelTest() {
      // Intentar varias claves histÃ³ricas
      const raw = localStorage.getItem('vocatioTestResults') || localStorage.getItem('vocatioTestResults_old') || localStorage.getItem('vocatioResults') || localStorage.getItem('vocatioResults_old');
      let data = null;
      if (raw) {
        try { data = JSON.parse(raw); } catch (e) { data = null; }
      }

      // Si no hay objeto, intentar otras claves aisladas
      if (!data) {
        const alt = localStorage.getItem('vocatioTestDate') || localStorage.getItem('vocatioResultsSimple');
        if (alt) {
          try { data = JSON.parse(alt); } catch (e) { data = null; }
        }
      }

      // Normalizar y extraer porcentajes en un mapa canÃ³nico
      const canonical = {
        'tecnologia': 'TecnologÃ­a', 'tecnologÃ­a': 'TecnologÃ­a', 'technology': 'TecnologÃ­a',
        'ciencias': 'Ciencias', 'science': 'Ciencias',
        'arte': 'Arte', 'arte y diseÃ±o': 'Arte', 'arteydiseno': 'Arte', 'innovacion': 'Arte', 'innovaciÃ³n': 'Arte',
        'negocios': 'Negocios', 'analisis': 'Negocios', 'anÃ¡lisis': 'Negocios', 'business': 'Negocios',
        'social': 'Social', 'salud': 'Social', 'psicologia': 'Social', 'medicina': 'Social', 'enfermeria': 'Social'
      };

      .profile-dropdown {
        position: relative;
      }

      // Inicializar mapa canÃ³nico con 0s
      const normalized = { 'TecnologÃ­a': 0, 'Ciencias': 0, 'Arte': 0, 'Negocios': 0, 'Social': 0 };

      .profile-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: var(--primary);
        color: var(--white);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 1.2rem;
      }

      // Escribir en los elementos de UI (los 5 bloques)
      document.getElementById('affinity-tecnologia').textContent = (normalized['TecnologÃ­a'] || 0) + '% de afinidad';
      document.getElementById('affinity-ciencias').textContent = (normalized['Ciencias'] || 0) + '% de afinidad';
      document.getElementById('affinity-arte').textContent = (normalized['Arte'] || 0) + '% de afinidad';
      document.getElementById('affinity-negocios').textContent = (normalized['Negocios'] || 0) + '% de afinidad';
      document.getElementById('affinity-social').textContent = (normalized['Social'] || 0) + '% de afinidad';

      // Fecha: preferir `vocatioTestDate`, luego `data.fecha` o `data.date`
      const dateRaw = localStorage.getItem('vocatioTestDate') || (data && (data.fecha || data.date));
      if (dateRaw) {
        try {
          const fecha = new Date(dateRaw).toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric' });
          document.getElementById('dateInfo').textContent = 'Realizado el ' + fecha;
        } catch (e) {
          document.getElementById('dateInfo').textContent = 'Realizado el ' + dateRaw;
        }
      }

      // Carreras recomendadas: preferir campos explÃ­citos, si no inferir segÃºn top categorÃ­as
      let carreras = [];
      if (data) {
        if (Array.isArray(data.carrerasRecomendadas) && data.carrerasRecomendadas.length) carreras = data.carrerasRecomendadas;
        else if (Array.isArray(data.recomendaciones) && data.recomendaciones.length) carreras = data.recomendaciones;
        else if (Array.isArray(data.recomendacionesCarreras) && data.recomendacionesCarreras.length) carreras = data.recomendacionesCarreras;
        else if (data.categoriaRecomendada) {
          const map = {
            'TecnologÃ­a': ['IngenierÃ­a de Sistemas','Ciencias de la ComputaciÃ³n','IngenierÃ­a de Software'],
            'Ciencias': ['BiologÃ­a','QuÃ­mica','FÃ­sica'],
            'Arte': ['DiseÃ±o GrÃ¡fico','Arquitectura','ComunicaciÃ³n Visual'],
            'Negocios': ['AdministraciÃ³n de Empresas','EconomÃ­a','Marketing'],
            'Social': ['Medicina','EnfermerÃ­a','PsicologÃ­a']
          };
          carreras = map[data.categoriaRecomendada] || [];
        }
      }

      // Si no hay carreras explÃ­citas, inferir por las 2 categorÃ­as con mayor porcentaje
      if ((!carreras || !carreras.length)) {
        const entries = Object.entries(normalized).sort((a,b) => b[1] - a[1]);
        const top = entries.slice(0,2).map(e => e[0]);
        const map = {
          'TecnologÃ­a': ['IngenierÃ­a de Sistemas','Ciencias de la ComputaciÃ³n','IngenierÃ­a InformÃ¡tica'],
          'Ciencias': ['BiologÃ­a','QuÃ­mica','FÃ­sica'],
          'Arte': ['DiseÃ±o GrÃ¡fico','Arquitectura','Artes Visuales'],
          'Negocios': ['AdministraciÃ³n de Empresas','EconomÃ­a','Contabilidad'],
          'Social': ['Medicina','EnfermerÃ­a','PsicologÃ­a']
        };
        top.forEach(cat => { if (map[cat]) carreras = carreras.concat(map[cat].slice(0,3)); });
      }

      // Asegurar que siempre haya contenido en la lista. Determinar origen de las recomendaciones
      const unique = carreras && carreras.length ? [...new Set(carreras)] : [];
      const sourceEl = document.getElementById('recommendation-source');
      // Si ya vienen carreras explÃ­citas desde los datos
      if (unique.length) {
        const listHTML = unique.map(c => `<li>${c}</li>`).join('');
        document.getElementById('recommended-list').innerHTML = listHTML;
        if (sourceEl) sourceEl.textContent = 'Basado en los resultados de tu test';
      } else {
        // Si no hay carreras explÃ­citas, inferir sÃ³lo si hay porcentajes (>0)
        const hasData = Object.values(normalized).some(v => v && v > 0);
        if (hasData) {
          const inferredEntries = Object.entries(normalized).sort((a,b) => b[1] - a[1]);
          const inferredTop = inferredEntries.slice(0,2).map(e => e[0]);
          const inferredMap = {
            'TecnologÃ­a': ['IngenierÃ­a de Sistemas','Ciencias de la ComputaciÃ³n','IngenierÃ­a InformÃ¡tica'],
            'Ciencias': ['BiologÃ­a','QuÃ­mica','FÃ­sica'],
            'Arte': ['DiseÃ±o GrÃ¡fico','Arquitectura','Artes Visuales'],
            'Negocios': ['AdministraciÃ³n de Empresas','EconomÃ­a','Contabilidad'],
            'Social': ['Medicina','EnfermerÃ­a','PsicologÃ­a']
          };
          let inferred = [];
          inferredTop.forEach(cat => { if (inferredMap[cat]) inferred = inferred.concat(inferredMap[cat].slice(0,3)); });
          const listHTML = [...new Set(inferred)].map(c => `<li>${c}</li>`).join('');
          document.getElementById('recommended-list').innerHTML = listHTML || '<li>AÃºn no hay carreras recomendadas</li>';
          if (sourceEl) sourceEl.textContent = 'Recomendaciones inferidas segÃºn tus afinidades';
        } else {
          // No hay datos del test: mostrar mensaje y guÃ­a
          document.getElementById('recommended-list').innerHTML = '<li>No hay datos del test. Toma el test para recibir recomendaciones personalizadas.</li>';
          if (sourceEl) sourceEl.textContent = 'Sin datos del test';
        }
      }

    // Inicializar valores
    document.addEventListener('DOMContentLoaded',function(){
      cargarDatosDelTest();
      applyTheme(currentTheme);
    });
  </script>
</body>
</html>

        // Inicializar mapa canÃ³nico con 0s
        const normalized = {
          TecnologÃ­a: 0,
          Ciencias: 0,
          Arte: 0,
          Negocios: 0,
          Social: 0,
        };

        if (rawPorcentajes) {
          Object.entries(rawPorcentajes).forEach(([k, v]) => {
            let key = String(k || "")
              .toLowerCase()
              .trim();
            // remover acentos para mejor matching
            const keyNoAcc = key
              .normalize("NFD")
              .replace(/\p{Diacritic}/gu, "");
            let canon = canonical[key] || canonical[keyNoAcc];
            // tambiÃ©n intentar sin espacios y sin caracteres especiales
            if (!canon) {
              const compact = keyNoAcc.replace(/[^a-z0-9]/g, "");
              canon = canonical[compact];
            }
            if (canon && normalized.hasOwnProperty(canon)) {
              const num =
                typeof v === "number"
                  ? v
                  : parseInt(String(v).replace(/[^0-9-]/g, "")) || 0;
              normalized[canon] = num;
            }
          });
        }

        // Escribir en los elementos de UI (los 5 bloques)
        document.getElementById("affinity-tecnologia").textContent =
          (normalized["TecnologÃ­a"] || 0) + "% de afinidad";
        document.getElementById("affinity-ciencias").textContent =
          (normalized["Ciencias"] || 0) + "% de afinidad";
        document.getElementById("affinity-arte").textContent =
          (normalized["Arte"] || 0) + "% de afinidad";
        document.getElementById("affinity-negocios").textContent =
          (normalized["Negocios"] || 0) + "% de afinidad";
        document.getElementById("affinity-social").textContent =
          (normalized["Social"] || 0) + "% de afinidad";

        // Fecha: preferir `vocatioTestDate`, luego `data.fecha` o `data.date`
        const dateRaw =
          localStorage.getItem("vocatioTestDate") ||
          (data && (data.fecha || data.date));
        if (dateRaw) {
          try {
            const fecha = new Date(dateRaw).toLocaleDateString("es-ES", {
              year: "numeric",
              month: "long",
              day: "numeric",
            });
            document.getElementById("dateInfo").textContent =
              "Realizado el " + fecha;
          } catch (e) {
            document.getElementById("dateInfo").textContent =
              "Realizado el " + dateRaw;
          }
        }

        // Carreras recomendadas: preferir campos explÃ­citos, si no inferir segÃºn top categorÃ­as
        let carreras = [];
        if (data) {
          if (
            Array.isArray(data.carrerasRecomendadas) &&
            data.carrerasRecomendadas.length
          )
            carreras = data.carrerasRecomendadas;
          else if (
            Array.isArray(data.recomendaciones) &&
            data.recomendaciones.length
          )
            carreras = data.recomendaciones;
          else if (
            Array.isArray(data.recomendacionesCarreras) &&
            data.recomendacionesCarreras.length
          )
            carreras = data.recomendacionesCarreras;
          else if (data.categoriaRecomendada) {
            const map = {
              TecnologÃ­a: [
                "IngenierÃ­a de Sistemas",
                "Ciencias de la ComputaciÃ³n",
                "IngenierÃ­a de Software",
              ],
              Ciencias: ["BiologÃ­a", "QuÃ­mica", "FÃ­sica"],
              Arte: ["DiseÃ±o GrÃ¡fico", "Arquitectura", "ComunicaciÃ³n Visual"],
              Negocios: ["AdministraciÃ³n de Empresas", "EconomÃ­a", "Marketing"],
              Social: ["Medicina", "EnfermerÃ­a", "PsicologÃ­a"],
            };
            carreras = map[data.categoriaRecomendada] || [];
          }
        }

        // Si no hay carreras explÃ­citas, inferir por las 2 categorÃ­as con mayor porcentaje
        if (!carreras || !carreras.length) {
          const entries = Object.entries(normalized).sort(
            (a, b) => b[1] - a[1]
          );
          const top = entries.slice(0, 2).map((e) => e[0]);
          const map = {
            TecnologÃ­a: [
              "IngenierÃ­a de Sistemas",
              "Ciencias de la ComputaciÃ³n",
              "IngenierÃ­a InformÃ¡tica",
            ],
            Ciencias: ["BiologÃ­a", "QuÃ­mica", "FÃ­sica"],
            Arte: ["DiseÃ±o GrÃ¡fico", "Arquitectura", "Artes Visuales"],
            Negocios: [
              "AdministraciÃ³n de Empresas",
              "EconomÃ­a",
              "Contabilidad",
            ],
            Social: ["Medicina", "EnfermerÃ­a", "PsicologÃ­a"],
          };
          top.forEach((cat) => {
            if (map[cat]) carreras = carreras.concat(map[cat].slice(0, 3));
          });
        }

        if (carreras && carreras.length) {
          const unique = [...new Set(carreras)];
          const listHTML = unique.map((c) => `<li>${c}</li>`).join("");
          document.getElementById("recommended-list").innerHTML = listHTML;
        }
      }

      // Inicializar valores
      document.addEventListener("DOMContentLoaded", function () {
        cargarDatosDelTest();
        applyTheme(currentTheme);
      });
    </script>
  </body>
</html>
