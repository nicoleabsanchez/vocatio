<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      name="description"
      content="Compartir resultados del test vocacional"
    />
    <title>Compartir Resultados - VOCATIO</title>
    <link rel="stylesheet" href="../../css/styles.css" />
    <link rel="stylesheet" href="../../css/components.css" />
    <link rel="stylesheet" href="../../css/responsive.css" />
    <style>
      /* Share Results Page Styles */
      .share-main {
        padding: var(--spacing-3xl) 0;
        background-color: var(--gray-lighter);
        min-height: calc(100vh - 80px);
      }

      .hamburger-menu {
        display: none;
      }

      .hamburger-icon {
        display: none;
        flex-direction: column;
        cursor: pointer;
        gap: 5px;
        padding: 8px;
        z-index: 1001;
      }

      .hamburger-icon span {
        width: 25px;
        height: 3px;
        background-color: var(--primary);
        border-radius: 3px;
        transition: all 0.3s ease;
      }

      .profile-dropdown-checkbox {
        display: none;
      }

      .profile-dropdown {
        position: relative;
      }

      .profile-dropdown-label {
        cursor: pointer;
        display: flex;
        align-items: center;
      }

      .profile-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: var(--primary);
        color: var(--white);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 1.2rem;
      }

      .dropdown-menu {
        position: absolute;
        top: 100%;
        right: 0;
        background-color: var(--white);
        border: 1px solid var(--gray-light);
        border-radius: var(--radius-md);
        box-shadow: var(--shadow-lg);
        margin-top: var(--spacing-sm);
        min-width: 200px;
        opacity: 0;
        visibility: hidden;
        transform: translateY(-10px);
        transition: all 0.3s ease;
        z-index: 1000;
      }

      .profile-dropdown-checkbox:checked ~ .dropdown-menu {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
      }

      .dropdown-menu a {
        display: block;
        padding: var(--spacing-md) var(--spacing-lg);
        color: var(--dark);
        text-decoration: none;
        transition: all 0.3s ease;
        border-bottom: 1px solid var(--gray-light);
      }

      .dropdown-menu a:last-child {
        border-bottom: none;
      }

      .dropdown-menu a:hover {
        background-color: var(--gray-lighter);
        color: var(--primary);
        padding-left: var(--spacing-xl);
      }

      .dropdown-menu a.logout {
        color: var(--error);
      }

      .dropdown-menu a.logout:hover {
        background-color: rgba(239, 68, 68, 0.1);
      }

      .page-header {
        background: linear-gradient(
          135deg,
          var(--primary) 0%,
          var(--primary-light) 100%
        );
        color: var(--white);
        padding: var(--spacing-3xl) 0;
        margin-bottom: var(--spacing-2xl);
        text-align: center;
      }

      .page-header h1 {
        font-size: 2.5rem;
        margin-bottom: var(--spacing-sm);
        color: var(--white);
      }

      .page-header p {
        font-size: 1.1rem;
        opacity: 0.95;
      }

      .share-container {
        display: grid;
        grid-template-columns: 1fr 400px;
        gap: var(--spacing-2xl);
        max-width: 1400px;
        margin: 0 auto;
        padding: 0 var(--spacing-lg);
      }

      .main-content {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-xl);
      }

      .results-card {
        background: var(--white);
        padding: var(--spacing-2xl);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-md);
      }

      .results-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: var(--spacing-lg);
        margin-bottom: var(--spacing-xl);
      }

      .result-item {
        background: var(--gray-lighter);
        border: 2px solid var(--primary-light);
        border-radius: var(--radius-lg);
        padding: var(--spacing-xl);
        text-align: center;
        transition: all 0.3s ease;
      }

      .result-item:hover {
        transform: translateY(-4px);
        box-shadow: var(--shadow-lg);
        border-color: var(--primary);
      }

      .result-emoji {
        font-size: 3rem;
        margin-bottom: var(--spacing-md);
      }

      .result-name {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--primary);
        margin-bottom: var(--spacing-sm);
      }

      .result-percentage {
        font-size: 0.95rem;
        color: var(--gray);
      }

      .date-info {
        text-align: center;
        color: var(--gray);
        padding-top: var(--spacing-lg);
        border-top: 2px solid var(--gray-light);
        font-size: 0.95rem;
      }

      .careers-card {
        background: var(--white);
        padding: var(--spacing-2xl);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-md);
      }

      .careers-title {
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--dark);
        margin-bottom: var(--spacing-lg);
      }

      .careers-list {
        list-style: none;
        display: flex;
        flex-direction: column;
        gap: var(--spacing-md);
      }

      .careers-list li {
        padding: var(--spacing-md);
        background: var(--gray-lighter);
        border-radius: var(--radius-md);
        border-left: 4px solid var(--primary);
        transition: all 0.3s ease;
      }

      .careers-list li:hover {
        background: var(--primary-light);
        color: var(--white);
        transform: translateX(4px);
      }

      .sidebar {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-xl);
      }

      .customize-card,
      .share-card {
        background: var(--white);
        padding: var(--spacing-xl);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-md);
      }

      .customize-title,
      .share-title {
        font-size: 1.3rem;
        font-weight: 600;
        color: var(--dark);
        margin-bottom: var(--spacing-lg);
      }

      .form-group {
        margin-bottom: var(--spacing-lg);
      }

      .form-label {
        display: block;
        font-weight: 500;
        color: var(--dark);
        margin-bottom: var(--spacing-sm);
      }

      .form-input,
      .form-textarea,
      .form-select {
        width: 100%;
        padding: var(--spacing-md);
        border: 2px solid var(--gray-light);
        border-radius: var(--radius-md);
        font-family: var(--font-primary);
        font-size: 1rem;
        transition: all 0.3s ease;
      }

      .form-input:focus,
      .form-textarea:focus,
      .form-select:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.1);
      }

      .form-textarea {
        resize: vertical;
        min-height: 100px;
      }

      .preview-btn,
      .download-btn {
        width: 100%;
        padding: var(--spacing-md) var(--spacing-lg);
        background: var(--primary);
        color: var(--white);
        border: none;
        border-radius: var(--radius-md);
        font-weight: 600;
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-top: var(--spacing-md);
      }

      .preview-btn:hover,
      .download-btn:hover {
        background: var(--primary-dark);
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
      }

      .social-buttons {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-md);
      }

      .social-btn {
        display: block;
        padding: var(--spacing-md);
        background: var(--gray-lighter);
        color: var(--dark);
        text-align: center;
        text-decoration: none;
        border-radius: var(--radius-md);
        font-weight: 500;
        transition: all 0.3s ease;
        border: 2px solid var(--gray-light);
      }

      .social-btn:hover {
        background: var(--primary);
        color: var(--white);
        border-color: var(--primary);
        transform: translateY(-2px);
      }

      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        z-index: 9999;
        align-items: center;
        justify-content: center;
        padding: var(--spacing-xl);
      }

      .modal.active {
        display: flex;
      }

      .modal-content {
        background: var(--white);
        border-radius: var(--radius-lg);
        padding: var(--spacing-3xl);
        max-width: 800px;
        width: 100%;
        max-height: 90vh;
        overflow-y: auto;
        position: relative;
      }

      .modal-close {
        position: absolute;
        top: var(--spacing-lg);
        right: var(--spacing-lg);
        width: 40px;
        height: 40px;
        border: none;
        background: var(--error);
        color: var(--white);
        font-size: 1.5rem;
        border-radius: 50%;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .modal-close:hover {
        background: var(--primary);
        transform: scale(1.1);
      }

      .preview-title {
        font-size: 1.8rem;
        font-weight: 600;
        color: var(--dark);
        margin-bottom: var(--spacing-2xl);
        text-align: center;
      }

      .help-button {
        position: fixed;
        bottom: 2rem;
        right: 2rem;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background-color: var(--white);
        border: 2px solid var(--dark);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        cursor: pointer;
        font-weight: 700;
        box-shadow: var(--shadow-lg);
        transition: all 0.3s ease;
        text-decoration: none;
        color: var(--dark);
        z-index: 999;
      }

      .help-button:hover {
        background-color: var(--dark);
        color: var(--white);
      }

      @media (max-width: 768px) {
        .hamburger-icon {
          display: flex;
        }

        .nav-menu {
          position: fixed;
          top: 70px;
          left: -100%;
          width: 100%;
          height: calc(100vh - 70px);
          background-color: var(--white);
          flex-direction: column;
          padding: var(--spacing-2xl);
          gap: var(--spacing-lg);
          transition: left 0.3s ease;
          box-shadow: var(--shadow-lg);
          overflow-y: auto;
          z-index: 999;
        }

        .hamburger-menu:checked ~ .navbar-content .nav-menu {
          left: 0;
        }

        .hamburger-menu:checked
          ~ .navbar-content
          .hamburger-icon
          span:nth-child(1) {
          transform: rotate(45deg) translate(8px, 8px);
        }

        .hamburger-menu:checked
          ~ .navbar-content
          .hamburger-icon
          span:nth-child(2) {
          opacity: 0;
        }

        .hamburger-menu:checked
          ~ .navbar-content
          .hamburger-icon
          span:nth-child(3) {
          transform: rotate(-45deg) translate(7px, -7px);
        }

        .share-container {
          grid-template-columns: 1fr;
        }

        .page-header h1 {
          font-size: 2rem;
        }

        .results-grid {
          grid-template-columns: repeat(2, 1fr);
        }

        .share-main {
          padding: var(--spacing-xl) 0;
        }
      }

      @media (max-width: 480px) {
        .results-grid {
          grid-template-columns: 1fr;
        }

        .page-header h1 {
          font-size: 1.5rem;
        }

        .modal-content {
          padding: var(--spacing-xl);
        }
      }
    </style>
  </head>
  <body>
    <!-- Navbar consistente para usuarios autenticados -->
    <nav class="navbar navbar-dashboard">
      <div class="navbar-container" style="max-width: 1400px; margin: 0 auto; padding: 0 var(--spacing-lg);">
        <input type="checkbox" id="menu-toggle" class="hamburger-menu" />
        <div class="navbar-content">
          <a href="../dashboard/dashboard.html" class="logo">
            <span class="logo-text">vocatio</span>
          </a>
          <label for="menu-toggle" class="hamburger-icon">
            <span></span>
            <span></span>
            <span></span>
          </label>
          <ul class="nav-menu">
            <li><a href="./explore.html">Explorar carreras</a></li>
            <li><a href="../events/events.html">Eventos</a></li>
            <li><a href="../vocational-test/test.html">Test vocacional</a></li>
            <li><a href="../results/results.html">Resultados</a></li>
            <li><a href="../dashboard/learning-path.html">Ruta de aprendizaje</a></li>
            <li><a href="../dashboard/progress.html">Progreso</a></li>
          </ul>
          <div class="profile-dropdown">
            <input
              type="checkbox"
              id="profile-dropdown-toggle"
              class="profile-dropdown-checkbox"
            />
            <label for="profile-dropdown-toggle" class="profile-dropdown-label">
              <div class="profile-icon">J</div>
            </label>
            <div class="dropdown-menu">
              <a href="../profile/profile.html">Mi Perfil</a>
              <a href="../notifications/notifications.html">Notificaciones</a>
              <a href="../../index.html" class="logout">Cerrar sesi√≥n</a>
            </div>
          </div>
        </div>
      </div>
    </nav>

    <!-- Page Header -->
    <div class="page-header">
      <h1>Mis Resultados</h1>
      <p style="color: #1b1b1b;">Personaliza y comparte tus resultados del test vocacional</p>
    </div>

    <!-- Main Content -->
    <main class="share-main">
      <div class="share-container">
        <div class="main-content">
          <div class="results-card" id="resultsCard">
            <div class="results-grid">
              <div class="result-item">
                <div class="result-emoji">üíª</div>
                <div class="result-name">Tecnolog√≠a</div>
                <div class="result-percentage" id="affinity-tecnologia">
                  ‚Äî% de afinidad
                </div>
              </div>
              <div class="result-item">
                <div class="result-emoji">üî¨</div>
                <div class="result-name">Ciencias</div>
                <div class="result-percentage" id="affinity-ciencias">
                  ‚Äî% de afinidad
                </div>
              </div>
              <div class="result-item">
                <div class="result-emoji">üé®</div>
                <div class="result-name">Arte</div>
                <div class="result-percentage" id="affinity-arte">
                  ‚Äî% de afinidad
                </div>
              </div>
              <div class="result-item">
                <div class="result-emoji">üíº</div>
                <div class="result-name">Negocios</div>
                <div class="result-percentage" id="affinity-negocios">
                  ‚Äî% de afinidad
                </div>
              </div>
              <div class="result-item">
                <div class="result-emoji">ü§ù</div>
                <div class="result-name">Social</div>
                <div class="result-percentage" id="affinity-social">
                  ‚Äî% de afinidad
                </div>
              </div>
            </div>
            <div class="date-info" id="dateInfo">Realizado el ‚Äî</div>
          </div>

          <div class="careers-card">
            <h3 class="careers-title">Carreras Recomendadas</h3>
            <ul class="careers-list" id="recommended-list">
              <!-- Se rellenar√° din√°micamente -->
            </ul>
          </div>
        </div>

        <div class="sidebar">
          <div class="customize-card">
            <h2 class="customize-title">‚ú® Personalizar</h2>
            <div class="form-group">
              <label class="form-label">T√≠tulo personalizado</label>
              <input
                type="text"
                class="form-input"
                id="customTitle"
                placeholder="Ej: ¬°Descubr√≠ mi vocaci√≥n!"
              />
            </div>
            <div class="form-group">
              <label class="form-label">Mensaje personalizado</label>
              <textarea
                class="form-textarea"
                id="customMessage"
                placeholder="Agrega un mensaje personal para compartir..."
              ></textarea>
            </div>
            <div class="form-group">
              <label class="form-label">Tema de color</label>
              <select class="form-select" id="colorTheme">
                <option value="purple">Morado (Predeterminado)</option>
                <option value="blue">Azul</option>
                <option value="green">Verde</option>
                <option value="orange">Naranja</option>
                <option value="pink">Rosa</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Mostrar fecha</label>
              <select class="form-select" id="showDate">
                <option value="yes">S√≠</option>
                <option value="no">No</option>
              </select>
            </div>
            <button class="preview-btn" id="previewBtn">üëÅÔ∏è Vista Previa</button>
          </div>

          <div class="share-card">
            <h3 class="share-title">Compartir en:</h3>
            <div class="social-buttons">
              <a href="#" class="social-btn" id="facebookBtn">üìò Facebook</a>
              <a href="#" class="social-btn" id="twitterBtn">üê¶ Twitter</a>
              <a href="#" class="social-btn" id="linkedinBtn">üíº LinkedIn</a>
              <a href="#" class="social-btn" id="instagramBtn">üì∑ Instagram</a>
              <button class="social-btn download-btn" id="downloadBtn">
                ‚¨áÔ∏è Descargar
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Help Button -->
    <a
      href="../help/help-center.html"
      class="help-button"
      aria-label="Centro de ayuda"
      >?</a
    >

    <div class="modal" id="previewModal">
      <div class="modal-content">
        <button class="modal-close" id="closeModal">√ó</button>
        <h2 class="preview-title">Vista Previa para Compartir</h2>
        <div id="previewContainer"></div>
        <p style="text-align: center; color: #8b8a92; margin-top: 15px">
          Esta es la vista previa de c√≥mo se ver√° tu publicaci√≥n
        </p>
      </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script>
      const themes = {
        purple: {
          primary: "#693efe",
          secondary: "#7e7af7",
          light: "#f9f8ff",
          border: "#d9d4ff",
        },
        blue: {
          primary: "#2563eb",
          secondary: "#3b82f6",
          light: "#eff6ff",
          border: "#bfdbfe",
        },
        green: {
          primary: "#059669",
          secondary: "#10b981",
          light: "#f0fdf4",
          border: "#bbf7d0",
        },
        orange: {
          primary: "#ea580c",
          secondary: "#f97316",
          light: "#fff7ed",
          border: "#fed7aa",
        },
        pink: {
          primary: "#db2777",
          secondary: "#ec4899",
          light: "#fdf2f8",
          border: "#fbcfe8",
        },
      };

      let currentTheme = "purple",
        customTitle = "",
        customMessage = "",
        showDate = true;

      function applyTheme(theme) {
        const colors = themes[theme];
        document.querySelectorAll(".result-item").forEach((item) => {
          item.style.backgroundColor = colors.light;
          item.style.borderColor = colors.border;
        });
        document
          .querySelectorAll(".result-name")
          .forEach((name) => (name.style.color = colors.primary));
        document
          .querySelectorAll(".result-percentage")
          .forEach((p) => (p.style.color = colors.secondary));
        document.querySelector(".logo").style.color = colors.primary;
        document
          .querySelectorAll(".preview-btn,.download-btn")
          .forEach((btn) => (btn.style.backgroundColor = colors.primary));
      }

      document
        .getElementById("colorTheme")
        .addEventListener("change", function (e) {
          currentTheme = e.target.value;
          applyTheme(currentTheme);
        });
      document
        .getElementById("showDate")
        .addEventListener("change", function (e) {
          showDate = e.target.value === "yes";
          document.getElementById("dateInfo").style.display = showDate
            ? "block"
            : "none";
        });
      document
        .getElementById("previewBtn")
        .addEventListener("click", function () {
          customTitle = document.getElementById("customTitle").value;
          customMessage = document.getElementById("customMessage").value;
          generatePreview();
        });

      function generatePreview() {
        const previewContainer = document.getElementById("previewContainer");
        const colors = themes[currentTheme];
        const previewCard = document.createElement("div");
        previewCard.style.cssText =
          "background:#fff;border-radius:20px;padding:40px;box-shadow:0 10px 30px rgba(105,62,254,0.1)";
        const logoEl = document.createElement("div");
        logoEl.textContent = "vocatio";
        logoEl.style.cssText = `font-size:42px;font-weight:700;color:${colors.primary};margin-bottom:20px;text-align:center`;
        previewCard.appendChild(logoEl);
        const titleEl = document.createElement("h2");
        titleEl.textContent = customTitle || "¬°Descubr√≠ mi vocaci√≥n!";
        titleEl.style.cssText =
          "font-size:28px;font-weight:700;color:#1b1b1b;margin-bottom:15px;text-align:center";
        previewCard.appendChild(titleEl);
        const resultsGrid = document.createElement("div");
        resultsGrid.style.cssText =
          "display:grid;grid-template-columns:repeat(2,1fr);gap:15px;margin:25px 0";
        const results = [
          {
            emoji: "üíª",
            name: "Tecnolog√≠a",
            percentage: document.getElementById("affinity-tecnologia")
              .textContent,
          },
          {
            emoji: "üî¨",
            name: "Ciencias",
            percentage:
              document.getElementById("affinity-ciencias").textContent,
          },
          {
            emoji: "üé®",
            name: "Arte",
            percentage: document.getElementById("affinity-innovacion")
              .textContent,
          },
          {
            emoji: "üíº",
            name: "Negocios",
            percentage:
              document.getElementById("affinity-analisis").textContent,
          },
        ];
        results.forEach((result) => {
          const item = document.createElement("div");
          item.style.cssText = `background:${colors.light};border:3px solid ${colors.border};border-radius:15px;padding:20px;text-align:center`;
          item.innerHTML = `<div style="font-size:40px;margin-bottom:8px;">${result.emoji}</div><div style="font-size:20px;font-weight:700;color:${colors.primary};margin-bottom:5px;">${result.name}</div><div style="font-size:14px;color:${colors.secondary};">${result.percentage}</div>`;
          resultsGrid.appendChild(item);
        });
        previewCard.appendChild(resultsGrid);
        if (showDate) {
          const dateEl = document.createElement("div");
          dateEl.textContent = document.getElementById("dateInfo").textContent;
          dateEl.style.cssText = `text-align:center;color:${colors.secondary};font-size:14px;margin-top:15px;padding-top:15px;border-top:2px solid ${colors.border}`;
          previewCard.appendChild(dateEl);
        }
        if (customMessage) {
          const messageEl = document.createElement("p");
          messageEl.textContent = customMessage;
          messageEl.style.cssText =
            "font-size:16px;color:#67666f;margin-top:20px;text-align:center;line-height:1.6;padding:15px;background:#f9f8ff;border-radius:10px";
          previewCard.appendChild(messageEl);
        }
        const hashtagsEl = document.createElement("div");
        hashtagsEl.textContent = "#Vocatio #TestVocacional #MiVocaci√≥n";
        hashtagsEl.style.cssText = `text-align:center;color:${colors.primary};font-size:14px;margin-top:20px;font-weight:600`;
        previewCard.appendChild(hashtagsEl);
        previewContainer.innerHTML = "";
        previewContainer.appendChild(previewCard);
        document.getElementById("previewModal").classList.add("active");
      }

      document
        .getElementById("closeModal")
        .addEventListener("click", function () {
          document.getElementById("previewModal").classList.remove("active");
        });
      document
        .getElementById("previewModal")
        .addEventListener("click", function (e) {
          if (e.target === this) this.classList.remove("active");
        });

      function getShareUrl(network) {
        const pageUrl = encodeURIComponent(window.location.href);
        const title =
          customTitle || "¬°Mira mis resultados del test vocacional!";
        const message =
          customMessage || "Descubr√≠ mis √°reas de mayor afinidad vocacional";
        const text = encodeURIComponent(
          `${title} ${message} en Vocatio üíªüî¨ #Vocatio #TestVocacional`
        );
        switch (network) {
          case "facebook":
            return `https://www.facebook.com/sharer/sharer.php?u=${pageUrl}`;
          case "twitter":
            return `https://twitter.com/intent/tweet?url=${pageUrl}&text=${text}`;
          case "linkedin":
            return `https://www.linkedin.com/sharing/share-offsite/?url=${pageUrl}`;
          default:
            return null;
        }
      }

      document
        .getElementById("facebookBtn")
        .addEventListener("click", function (e) {
          e.preventDefault();
          const url = getShareUrl("facebook");
          if (url) window.open(url, "_blank", "width=600,height=400");
        });
      document
        .getElementById("twitterBtn")
        .addEventListener("click", function (e) {
          e.preventDefault();
          const url = getShareUrl("twitter");
          if (url) window.open(url, "_blank", "width=600,height=400");
        });
      document
        .getElementById("linkedinBtn")
        .addEventListener("click", function (e) {
          e.preventDefault();
          const url = getShareUrl("linkedin");
          if (url) window.open(url, "_blank", "width=600,height=400");
        });
      document
        .getElementById("instagramBtn")
        .addEventListener("click", function (e) {
          e.preventDefault();
          alert(
            'üí° Consejo: Usa el bot√≥n "Descargar" para guardar tu resultado y compartirlo en Instagram Stories o Feed'
          );
        });

      document
        .getElementById("downloadBtn")
        .addEventListener("click", async function () {
          this.textContent = "‚è≥ Generando...";
          this.disabled = true;
          try {
            const tempDiv = document.createElement("div");
            tempDiv.style.cssText = "position:fixed;left:-9999px;top:0";
            document.body.appendChild(tempDiv);
            const colors = themes[currentTheme];
            const previewCard = document.createElement("div");
            previewCard.style.cssText = `background:#fff;width:1200px;padding:60px;font-family:'Inter',sans-serif`;
            const logoEl = document.createElement("div");
            logoEl.textContent = "vocatio";
            logoEl.style.cssText = `font-size:52px;font-weight:700;color:${colors.primary};margin-bottom:25px;text-align:center`;
            previewCard.appendChild(logoEl);
            const titleEl = document.createElement("h2");
            titleEl.textContent = customTitle || "¬°Descubr√≠ mi vocaci√≥n!";
            titleEl.style.cssText =
              "font-size:36px;font-weight:700;color:#1b1b1b;margin-bottom:20px;text-align:center";
            previewCard.appendChild(titleEl);
            const resultsGrid = document.createElement("div");
            resultsGrid.style.cssText =
              "display:grid;grid-template-columns:repeat(2,1fr);gap:20px;margin:30px 0";
            const results = [
              {
                emoji: "üíª",
                name: "Tecnolog√≠a",
                percentage: document.getElementById("affinity-tecnologia")
                  .textContent,
              },
              {
                emoji: "üî¨",
                name: "Ciencias",
                percentage:
                  document.getElementById("affinity-ciencias").textContent,
              },
              {
                emoji: "üé®",
                name: "Arte",
                percentage: document.getElementById("affinity-innovacion")
                  .textContent,
              },
              {
                emoji: "üíº",
                name: "Negocios",
                percentage:
                  document.getElementById("affinity-analisis").textContent,
              },
            ];
            results.forEach((result) => {
              const item = document.createElement("div");
              item.style.cssText = `background:${colors.light};border:3px solid ${colors.border};border-radius:15px;padding:30px;text-align:center`;
              item.innerHTML = `<div style="font-size:52px;margin-bottom:10px">${result.emoji}</div><div style="font-size:26px;font-weight:700;color:${colors.primary};margin-bottom:8px">${result.name}</div><div style="font-size:18px;color:${colors.secondary}">${result.percentage}</div>`;
              resultsGrid.appendChild(item);
            });
            previewCard.appendChild(resultsGrid);
            if (showDate) {
              const dateEl = document.createElement("div");
              dateEl.textContent =
                document.getElementById("dateInfo").textContent;
              dateEl.style.cssText = `text-align:center;color:${colors.secondary};font-size:16px;margin-top:20px;padding-top:20px;border-top:2px solid ${colors.border}`;
              previewCard.appendChild(dateEl);
            }
            if (customMessage) {
              const messageEl = document.createElement("p");
              messageEl.textContent = customMessage;
              messageEl.style.cssText =
                "font-size:18px;color:#67666f;margin-top:25px;text-align:center;line-height:1.6;padding:20px;background:#f9f8ff;border-radius:10px";
              previewCard.appendChild(messageEl);
            }
            const hashtagsEl = document.createElement("div");
            hashtagsEl.textContent = "#Vocatio #TestVocacional #MiVocaci√≥n";
            hashtagsEl.style.cssText = `text-align:center;color:${colors.primary};font-size:16px;margin-top:25px;font-weight:600`;
            previewCard.appendChild(hashtagsEl);
            tempDiv.appendChild(previewCard);
            const canvas = await html2canvas(previewCard, {
              backgroundColor: "#ffffff",
              scale: 2,
              logging: false,
              width: 1200,
            });
            document.body.removeChild(tempDiv);
            const link = document.createElement("a");
            link.download = "mis-resultados-vocatio.png";
            link.href = canvas.toDataURL("image/png");
            link.click();
            this.textContent = "‚úÖ ¬°Descargado!";
            setTimeout(() => {
              this.textContent = "‚¨áÔ∏è Descargar";
              this.disabled = false;
            }, 2000);
          } catch (error) {
            console.error("Error al generar imagen:", error);
            this.textContent = "‚ùå Error";
            setTimeout(() => {
              this.textContent = "‚¨áÔ∏è Descargar";
              this.disabled = false;
            }, 2000);
          }
        });

      // Cargar datos del test vocacional desde localStorage (versi√≥n robusta y normalizada)
      function cargarDatosDelTest() {
        // Intentar varias claves hist√≥ricas
        const raw =
          localStorage.getItem("vocatioTestResults") ||
          localStorage.getItem("vocatioTestResults_old") ||
          localStorage.getItem("vocatioResults") ||
          localStorage.getItem("vocatioResults_old");
        let data = null;
        if (raw) {
          try {
            data = JSON.parse(raw);
          } catch (e) {
            data = null;
          }
        }

        // Si no hay objeto, intentar otras claves aisladas
        if (!data) {
          const alt =
            localStorage.getItem("vocatioTestDate") ||
            localStorage.getItem("vocatioResultsSimple");
          if (alt) {
            try {
              data = JSON.parse(alt);
            } catch (e) {
              data = null;
            }
          }
        }

        // Normalizar y extraer porcentajes en un mapa can√≥nico
        const canonical = {
          tecnologia: "Tecnolog√≠a",
          tecnolog√≠a: "Tecnolog√≠a",
          technology: "Tecnolog√≠a",
          ciencias: "Ciencias",
          science: "Ciencias",
          arte: "Arte",
          "arte y dise√±o": "Arte",
          arteydiseno: "Arte",
          innovacion: "Arte",
          innovaci√≥n: "Arte",
          negocios: "Negocios",
          analisis: "Negocios",
          an√°lisis: "Negocios",
          business: "Negocios",
          social: "Social",
          salud: "Social",
          psicologia: "Social",
          medicina: "Social",
          enfermeria: "Social",
        };

        let rawPorcentajes = null;
        if (data) {
          if (data.porcentajes) rawPorcentajes = data.porcentajes;
          else if (data.categorias) rawPorcentajes = data.categorias;
          else if (data.interests) rawPorcentajes = data.interests;
          else if (Array.isArray(data)) {
            // formato [{name, value}, ...]
            rawPorcentajes = {};
            data.forEach((i) => {
              if (i && i.name)
                rawPorcentajes[i.name] = i.value || i.percentage || 0;
            });
          } else if (typeof data === "object") {
            // intentar detectar campos planos
            if (data.Tecnolog√≠a || data.Tecnologia || data.tecnologia)
              rawPorcentajes = data;
          }
        }

        // Inicializar mapa can√≥nico con 0s
        const normalized = {
          Tecnolog√≠a: 0,
          Ciencias: 0,
          Arte: 0,
          Negocios: 0,
          Social: 0,
        };

        if (rawPorcentajes) {
          Object.entries(rawPorcentajes).forEach(([k, v]) => {
            let key = String(k || "")
              .toLowerCase()
              .trim();
            // remover acentos para mejor matching
            const keyNoAcc = key
              .normalize("NFD")
              .replace(/\p{Diacritic}/gu, "");
            let canon = canonical[key] || canonical[keyNoAcc];
            // tambi√©n intentar sin espacios y sin caracteres especiales
            if (!canon) {
              const compact = keyNoAcc.replace(/[^a-z0-9]/g, "");
              canon = canonical[compact];
            }
            if (canon && normalized.hasOwnProperty(canon)) {
              const num =
                typeof v === "number"
                  ? v
                  : parseInt(String(v).replace(/[^0-9-]/g, "")) || 0;
              normalized[canon] = num;
            }
          });
        }

        // Escribir en los elementos de UI (los 5 bloques)
        document.getElementById("affinity-tecnologia").textContent =
          (normalized["Tecnolog√≠a"] || 0) + "% de afinidad";
        document.getElementById("affinity-ciencias").textContent =
          (normalized["Ciencias"] || 0) + "% de afinidad";
        document.getElementById("affinity-arte").textContent =
          (normalized["Arte"] || 0) + "% de afinidad";
        document.getElementById("affinity-negocios").textContent =
          (normalized["Negocios"] || 0) + "% de afinidad";
        document.getElementById("affinity-social").textContent =
          (normalized["Social"] || 0) + "% de afinidad";

        // Fecha: preferir `vocatioTestDate`, luego `data.fecha` o `data.date`
        const dateRaw =
          localStorage.getItem("vocatioTestDate") ||
          (data && (data.fecha || data.date));
        if (dateRaw) {
          try {
            const fecha = new Date(dateRaw).toLocaleDateString("es-ES", {
              year: "numeric",
              month: "long",
              day: "numeric",
            });
            document.getElementById("dateInfo").textContent =
              "Realizado el " + fecha;
          } catch (e) {
            document.getElementById("dateInfo").textContent =
              "Realizado el " + dateRaw;
          }
        }

        // Carreras recomendadas: preferir campos expl√≠citos, si no inferir seg√∫n top categor√≠as
        let carreras = [];
        if (data) {
          if (
            Array.isArray(data.carrerasRecomendadas) &&
            data.carrerasRecomendadas.length
          )
            carreras = data.carrerasRecomendadas;
          else if (
            Array.isArray(data.recomendaciones) &&
            data.recomendaciones.length
          )
            carreras = data.recomendaciones;
          else if (
            Array.isArray(data.recomendacionesCarreras) &&
            data.recomendacionesCarreras.length
          )
            carreras = data.recomendacionesCarreras;
          else if (data.categoriaRecomendada) {
            const map = {
              Tecnolog√≠a: [
                "Ingenier√≠a de Sistemas",
                "Ciencias de la Computaci√≥n",
                "Ingenier√≠a de Software",
              ],
              Ciencias: ["Biolog√≠a", "Qu√≠mica", "F√≠sica"],
              Arte: ["Dise√±o Gr√°fico", "Arquitectura", "Comunicaci√≥n Visual"],
              Negocios: ["Administraci√≥n de Empresas", "Econom√≠a", "Marketing"],
              Social: ["Medicina", "Enfermer√≠a", "Psicolog√≠a"],
            };
            carreras = map[data.categoriaRecomendada] || [];
          }
        }

        // Si no hay carreras expl√≠citas, inferir por las 2 categor√≠as con mayor porcentaje
        if (!carreras || !carreras.length) {
          const entries = Object.entries(normalized).sort(
            (a, b) => b[1] - a[1]
          );
          const top = entries.slice(0, 2).map((e) => e[0]);
          const map = {
            Tecnolog√≠a: [
              "Ingenier√≠a de Sistemas",
              "Ciencias de la Computaci√≥n",
              "Ingenier√≠a Inform√°tica",
            ],
            Ciencias: ["Biolog√≠a", "Qu√≠mica", "F√≠sica"],
            Arte: ["Dise√±o Gr√°fico", "Arquitectura", "Artes Visuales"],
            Negocios: [
              "Administraci√≥n de Empresas",
              "Econom√≠a",
              "Contabilidad",
            ],
            Social: ["Medicina", "Enfermer√≠a", "Psicolog√≠a"],
          };
          top.forEach((cat) => {
            if (map[cat]) carreras = carreras.concat(map[cat].slice(0, 3));
          });
        }

        if (carreras && carreras.length) {
          const unique = [...new Set(carreras)];
          const listHTML = unique.map((c) => `<li>${c}</li>`).join("");
          document.getElementById("recommended-list").innerHTML = listHTML;
        }
      }

      // Inicializar valores
      document.addEventListener("DOMContentLoaded", function () {
        cargarDatosDelTest();
        applyTheme(currentTheme);
      });
    </script>
  </body>
</html>
