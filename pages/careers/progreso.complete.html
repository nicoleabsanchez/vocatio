<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Progreso del Estudiante</title>
    <link href="https://fonts.googleapis.com/css?family=Inter:400,700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../../css/main-progreso.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: #fafafa; color: #2d2d2d; }
        .barra-estado-global { background: white; padding: 20px 40px; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: 1.8rem; font-weight: 700; color: #6c63ff; }
        .nav-global { display: flex; gap: 30px; }
        .nav-global a { color: #666; text-decoration: none; font-size: 0.95rem; transition: color 0.3s; }
        .nav-global a.active, .nav-global a:hover { color: #6c63ff; font-weight: 600; }
        .usuario { font-size: 1.5rem; cursor: pointer; }
        .container { max-width: 1400px; margin: 0 auto; padding: 40px; }
        .barra-progreso { background: white; padding: 30px; border-radius: 12px; margin-bottom: 30px; }
        .barra-progreso label { font-weight: 600; display: block; margin-bottom: 12px; }
        .progress-bar { background: #f0f0f0; height: 10px; border-radius: 5px; overflow: hidden; }
        .progress { background: linear-gradient(90deg, #d4ff00, #b4e600); height: 100%; border-radius: 5px; }
        header { margin-bottom: 30px; }
        header h1 { font-size: 2.5rem; font-weight: 700; margin-bottom: 10px; }
        header p { color: #b2a6ff; font-size: 1.1rem; margin-bottom: 15px; }
        .mensaje-cero { background: white; padding: 20px; border-radius: 8px; border-left: 4px solid #d4ff00; color: #666; }
        .resumen { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 40px; }
        .card { background: white; padding: 30px; border-radius: 12px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .icon { font-size: 2.5rem; display: block; margin-bottom: 15px; }
        .value { display: block; font-size: 2.5rem; font-weight: 700; color: #6c63ff; margin-bottom: 8px; }
        .label { display: block; color: #666; font-size: 0.95rem; font-weight: 500; }
        .intereses, .actividad-semanal { background: white; padding: 30px; border-radius: 12px; margin-bottom: 30px; }
        .intereses h2, .actividad-semanal h2 { font-size: 1.3rem; font-weight: 600; margin-bottom: 25px; }
        .grafica-intereses, .grafica-semanal { display: flex; align-items: flex-end; justify-content: space-between; height: 250px; gap: 15px; }
        /* Interest bar: percent above, fill grows from bottom */
        .barra { background: transparent; border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: flex-end; min-width: 50px; flex: 1; position: relative; }
        .barra .percent { color: #6c63ff; font-weight: 700; margin-bottom: 8px; }
        .barra .bar-fill { width: 100%; background: linear-gradient(180deg, #8b7fff, #6c63ff); border-radius: 8px 8px 0 0; transition: height 0.5s ease; display: block; }
        .barra .label { font-size: 0.85rem; color: #666; text-align: center; margin-top: 8px; }
        .barra-dia { background: linear-gradient(180deg, #8b7fff, #6c63ff); border-radius: 8px 8px 0 0; display: flex; flex-direction: column; align-items: center; justify-content: flex-end; padding-bottom: 10px; flex: 1; }
        .barra-dia span { color: #6c63ff; font-weight: 600; margin-bottom: 8px; }
        .barra-dia div { font-size: 0.85rem; color: #666; text-align: center; margin-top: 10px; }
        .btn-principal { background: #6c63ff; color: white; border: none; padding: 15px 40px; border-radius: 8px; font-weight: 600; font-size: 1rem; cursor: pointer; float: right; transition: background 0.3s; }
        .btn-principal:hover { background: #5a52d5; }
        .detalle-actividades { display: flex; flex-direction: column; gap: 20px; margin-bottom: 40px; }
        .actividad-box { background: white; border: 1px solid #f0f0f0; border-radius: 12px; padding: 20px; display: flex; align-items: center; gap: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); transition: box-shadow 0.3s; }
        .actividad-box:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.12); }
        .icono { font-size: 2.5rem; min-width: 50px; display: flex; align-items: center; justify-content: center; }
        .info { flex: 1; }
        .info strong { display: block; font-size: 1.1rem; font-weight: 600; color: #2d2d2d; margin-bottom: 5px; }
        .info .sub { color: #b2a6ff; font-size: 0.9rem; }
        .barra-actividad { display: flex; align-items: center; gap: 12px; min-width: 300px; }
        .barra-actividad .barra { flex: 1; height: 8px; border-radius: 4px; background: #f0f0f0; position: relative; }
        .barra-actividad span { font-weight: 600; color: #6c63ff; min-width: 40px; text-align: right; }
        footer { text-align: center; padding: 30px 0; border-top: 1px solid #f0f0f0; margin-top: 40px; clear: both; }
        footer nav { display: flex; justify-content: center; gap: 20px; flex-wrap: wrap; }
        footer a { color: #666; text-decoration: none; font-size: 0.95rem; transition: color 0.3s; }
        footer a:hover, footer a.active { color: #6c63ff; font-weight: 600; }
        @media (max-width: 768px) { .resumen { grid-template-columns: repeat(2, 1fr); } .nav-global { gap: 15px; font-size: 0.9rem; } .actividad-box { flex-direction: column; align-items: flex-start; } .barra-actividad { min-width: auto; width: 100%; } }
    </style>
</head>
<body>
    <!-- Barra de estado global -->
    <div class="barra-estado-global">
        <div class="logo">vocatio</div>
        <nav class="nav-global">
            <a href="./explore.html">Explorar carreras</a>
            <a href="../events/events.html">Eventos</a>
            <a href="../vocational-test/test.html">Test vocacional</a>
            <a href="./us20-compartir-resultados-en-redes-sociales-p1.html">Resultados</a>
            <a href="../dashboard/learning-path.html">Ruta de aprendizaje</a>
            <a href="./progreso.complete.html" class="active">Progreso</a>
        </nav>
        <div class="usuario"><span style="font-size:1.7em;vertical-align:middle;">&#128100;</span></div>
    </div>
    <div class="container">
        <section class="barra-progreso" id="barraProgresoSection">
            <label for="barra">Progreso General</label>
            <div class="progress-bar" id="progressBarClickable" style="cursor:pointer;">
                <div class="progress" id="barraProgreso" style="width: 0%"></div>
            </div>
        </section>
        <!-- Vista 1: Resumen con gr√°ficas -->
        <div id="vistaResumen">
            <header>
                <h1>Mi Progreso</h1>
                <p>Visualiza tu avance en Vocatio y tus logros alcanzados</p>
                <div id="mensajeProgresoCero" class="mensaje-cero" style="display:block;">A√∫n no has completado ninguna actividad. ¬°Comienza para ver tu progreso!</div>
            </header>
            <section class="resumen">
                <div class="card">
                    <span class="icon">üìä</span>
                    <span class="value" id="testsCompletados">0</span>
                    <span class="label">Tests Completados</span>
                </div>
                <div class="card">
                    <span class="icon">‚≠ê</span>
                    <span class="value" id="carrerasExploradas">0</span>
                    <span class="label">Carreras Exploradas</span>
                </div>
                <div class="card">
                    <span class="icon">üìö</span>
                    <span class="value" id="materialesRevisados">0</span>
                    <span class="label">Materiales Revisados</span>
                </div>
                <div class="card">
                    <span class="icon">üéØ</span>
                    <span class="value" id="progresoTotal">0%</span>
                    <span class="label">Progreso Total</span>
                </div>
            </section>
            <section class="intereses">
                <h2>Intereses Predominantes</h2>
                <div class="grafica-intereses">
                    <div class="barra" data-cat="Tecnolog√≠a"><div class="percent">0%</div><div class="bar-fill" style="height:0%"></div><div class="label">Tecnolog√≠a</div></div>
                    <div class="barra" data-cat="Ciencias"><div class="percent">0%</div><div class="bar-fill" style="height:0%"></div><div class="label">Ciencias</div></div>
                    <div class="barra" data-cat="Arte"><div class="percent">0%</div><div class="bar-fill" style="height:0%"></div><div class="label">Arte</div></div>
                    <div class="barra" data-cat="Negocios"><div class="percent">0%</div><div class="bar-fill" style="height:0%"></div><div class="label">Negocios</div></div>
                    <div class="barra" data-cat="Social"><div class="percent">0%</div><div class="bar-fill" style="height:0%"></div><div class="label">Social</div></div>
                </div>
            </section>
            <section class="actividad-semanal">
                <h2>Actividad Semanal</h2>
                <div class="grafica-semanal">
                    <div class="barra-dia" data-fecha="" data-day-index="0" style="height:5%"><span>0</span><div>Lun</div></div>
                    <div class="barra-dia" data-fecha="" data-day-index="1" style="height:5%"><span>0</span><div>Mar</div></div>
                    <div class="barra-dia" data-fecha="" data-day-index="2" style="height:5%"><span>0</span><div>Mi√©</div></div>
                    <div class="barra-dia" data-fecha="" data-day-index="3" style="height:5%"><span>0</span><div>Jue</div></div>
                    <div class="barra-dia" data-fecha="" data-day-index="4" style="height:5%"><span>0</span><div>Vie</div></div>
                    <div class="barra-dia" data-fecha="" data-day-index="5" style="height:5%"><span>0</span><div>S√°b</div></div>
                    <div class="barra-dia" data-fecha="" data-day-index="6" style="height:5%"><span>0</span><div>Dom</div></div>
                </div>
            </section>
            <button id="btnSiguiente" class="btn-principal">Siguiente</button>
        </div>
        <!-- Vista 2: Detalle de actividades -->
        <div id="vistaDetalle" style="display:none;">
            <header>
                <h1>Mi Progreso</h1>
                <p>Visualiza tu avance en Vocatio y tus logros alcanzados</p>
                <div id="mensajeProgresoCeroDetalle" class="mensaje-cero" style="display:block;">A√∫n no has completado ninguna actividad. ¬°Comienza para ver tu progreso!</div>
            </header>
            <div class="detalle-actividades" id="actividadesContainer">
                <!-- Se llena din√°micamente con JavaScript -->
            </div>
            <button id="btnVolver" class="btn-principal">Volver</button>
        </div>
        <footer>
            <nav>
                <a href="./explore.html">Explorar carreras</a>
                <a href="../events/events.html">Eventos</a>
                <a href="../vocational-test/test.html">Test vocacional</a>
                <a href="../dashboard/learning-path.html">Ruta de aprendizaje</a>
                <a href="./progreso.complete.html" class="active">Progreso</a>
                <a href="./us20-compartir-resultados-en-redes-sociales-p1.html">Resultados</a>
            </nav>
        </footer>
    </div>
    <script src="./js/main-progreso.js"></script>
    <script>
        // Manejo de vistas
        const btnSiguiente = document.getElementById('btnSiguiente');
        const btnVolver = document.getElementById('btnVolver');
        const vistaResumen = document.getElementById('vistaResumen');
        const vistaDetalle = document.getElementById('vistaDetalle');

        btnSiguiente.addEventListener('click', function() {
            vistaResumen.style.display = 'none';
            vistaDetalle.style.display = 'block';
            window.scrollTo(0, 0);
        });

        btnVolver.addEventListener('click', function() {
            vistaDetalle.style.display = 'none';
            vistaResumen.style.display = 'block';
            window.scrollTo(0, 0);
        });

        // Datos del usuario - Comienza en cero, se actualiza seg√∫n actividades reales
        const userData = {
            testsCompleted: 0,  // Se incrementa cuando usuario completa un test
            careersExplored: 0,  // Se incrementa cuando usuario explora carreras
            materialsReviewed: 0,  // Se incrementa cuando usuario revisa materiales
            totalProgress: 0,  // Se calcula: (tests + carreras + materiales) / 3
            interests: {
                technology: 0,  // Se actualiza seg√∫n resultados del test
                science: 0,
                art: 0,
                business: 0,
                social: 0
            },
            weekActivity: [0, 0, 0, 0, 0, 0, 0],  // Lun a Dom
            activities: [
                // Formato: { type: 'test'|'material'|'career'|'rating', name, progress, timeSpent, timestamp, careerName }
            ]
        };

        // Funci√≥n para generar actividades din√°micamente
        function renderActivities() {
            const container = document.getElementById('actividadesContainer');
            const hasActivities = userData.activities && userData.activities.length > 0;

            if (!hasActivities) {
                container.innerHTML = '';
                return;
            }

            container.innerHTML = userData.activities.map(activity => {
                let icono = 'üìä';
                let titulo = '';
                let subtitulo = '';
                let mostrarProgreso = false;
                let progreso = 0;

                const tiempoTranscurrido = getTimeAgo(activity.timestamp);

                switch(activity.type) {
                    case 'test':
                        icono = 'üìã';
                        titulo = 'Test Vocacional - Completado';
                        subtitulo = `${tiempoTranscurrido} ‚Ä¢ ${activity.careerName || 'Resultado pendiente'}`;
                        mostrarProgreso = true;
                        progreso = 100;  // El test se marca como completado
                        break;
                    case 'material':
                        icono = 'üìö';
                        titulo = `Material: ${activity.name}`;
                        subtitulo = `${activity.timeSpent > 0 ? 'En progreso' : 'Iniciado'} ‚Ä¢ ${activity.timeSpent} min ${activity.timeSpent > 0 ? 'invertidos' : ''}`;
                        mostrarProgreso = true;
                        progreso = activity.progress || 0;
                        break;
                    case 'career':
                        icono = '‚≠ê';
                        titulo = 'Carrera Guardada como Favorita';
                        subtitulo = `${tiempoTranscurrido} ‚Ä¢ ${activity.careerName || 'Carrera'}`;
                        break;
                    case 'rating':
                        icono = 'üí¨';
                        titulo = 'Calificaci√≥n de Material';
                        subtitulo = `${tiempoTranscurrido} ‚Ä¢ ${activity.name} - ${activity.rating || 5} estrellas`;
                        break;
                }

                return `
                    <div class="actividad-box">
                        <div class="icono">${icono}</div>
                        <div class="info">
                            <strong>${titulo}</strong>
                            <div class="sub">${subtitulo}</div>
                        </div>
                        ${mostrarProgreso ? `<div class="barra-actividad"><div class="barra" style="width:${progreso}%;background:#d4ff00;"></div><span>${progreso}%</span></div>` : ''}
                    </div>
                `;
            }).join('');
        }

        // Funci√≥n auxiliar para calcular tiempo transcurrido
        function getTimeAgo(timestamp) {
            if (!timestamp) return 'Hace poco';
            const now = new Date();
            const time = new Date(timestamp);
            const diff = Math.floor((now - time) / 1000);  // Segundos

            if (diff < 60) return 'Hace poco';
            if (diff < 3600) return `Hace ${Math.floor(diff / 60)} min`;
            if (diff < 86400) return `Hace ${Math.floor(diff / 3600)} h`;
            return `Hace ${Math.floor(diff / 86400)} d√≠as`;
        }

        // Funci√≥n para actualizar toda la p√°gina
        function actualizarPagina() {
                // Cargar contadores persistentes
                // Tests: use 'vocatioTestsTaken' counter (number of times user completed test)
                const testsTaken = parseInt(localStorage.getItem('vocatioTestsTaken') || '0', 10);
                // If testsTaken is zero but a result exists, initialize to 1
                const rawTestResults = localStorage.getItem('vocatioTestResults');
                const hasTestResults = !!rawTestResults;
                let testsCount = testsTaken;
                if (testsCount === 0 && hasTestResults) {
                    testsCount = 1;
                    localStorage.setItem('vocatioTestsTaken', '1');
                }
                userData.testsCompleted = testsCount;

                // Intereses desde el √∫ltimo resultado
                if (hasTestResults) {
                    try {
                        const data = JSON.parse(rawTestResults);
                        // Usar la estructura de categor√≠as del test (Tecnolog√≠a, Ciencias, Arte, Negocios, Social)
                        if (data.categorias) {
                            // Mapeo de nombres en test a keys en userData.interests
                            userData.interests = {
                                technology: data.categorias['Tecnolog√≠a'] || data.categorias.Tecnologia || 0,
                                science: data.categorias['Ciencias'] || 0,
                                art: data.categorias['Arte'] || 0,
                                business: data.categorias['Negocios'] || 0,
                                social: data.categorias['Social'] || 0
                            };
                        } else if (data.interests) {
                            // Fallback a estructura antigua si existe
                            userData.interests = {
                                technology: data.interests.technology || 0,
                                science: data.interests.science || 0,
                                art: data.interests.art || 0,
                                business: data.interests.business || 0,
                                social: data.interests.social || 0
                            };
                        }
                    } catch (e) {
                        console.error('Error loading test results:', e);
                    }
                }

                // Carreras favoritas: prefer 'vocatioFavoriteCareers' else fallback to 'vocatioCareersExplored'
                try {
                    const favs = JSON.parse(localStorage.getItem('vocatioFavoriteCareers') || 'null');
                    if (Array.isArray(favs)) {
                        userData.careersExplored = favs.length;
                    } else {
                        const careersExplored = JSON.parse(localStorage.getItem('vocatioCareersExplored') || '[]');
                        userData.careersExplored = Array.isArray(careersExplored) ? careersExplored.length : 0;
                    }
                } catch (e) {
                    console.error('Error loading favorite careers:', e);
                }

                // Materiales revisados: stored as array 'vocatioMaterialsReviewed' OR track by selected career history
                try {
                    const materials = JSON.parse(localStorage.getItem('vocatioMaterialsReviewed') || 'null');
                    if (Array.isArray(materials)) {
                        userData.materialesRevisados = materials.length;
                        userData.materialsReviewed = materials.length;
                    }
                } catch (e) {
                    console.error('Error loading materials reviewed:', e);
                }
                // If a career was selected, ensure it's counted once in a by-career set
                try {
                    const sel = localStorage.getItem('vocatioSelectedCareer');
                    if (sel) {
                        const reviewedByCareer = JSON.parse(localStorage.getItem('vocatioMaterialsReviewedByCareer') || '[]');
                        const careerKey = typeof sel === 'string' ? sel : JSON.stringify(sel);
                        if (Array.isArray(reviewedByCareer)) {
                            if (!reviewedByCareer.includes(careerKey)) {
                                reviewedByCareer.push(careerKey);
                                localStorage.setItem('vocatioMaterialsReviewedByCareer', JSON.stringify(reviewedByCareer));
                            }
                            userData.materialsReviewed = reviewedByCareer.length;
                        }
                    }
                } catch (e) {
                    console.error('Error handling selected career materials:', e);
                }
            
            // Limitar progreso a 100%
            userData.totalProgress = Math.min(100, userData.totalProgress);
            
            // Intentar cargar datos adicionales de vocatioUserProgress
            const storedData = localStorage.getItem('vocatioUserProgress');
            if (storedData) {
                try {
                    const loaded = JSON.parse(storedData);
                    if (loaded.activities && Array.isArray(loaded.activities)) {
                        userData.activities = loaded.activities;
                    }
                        if (Array.isArray(loaded.weekActivity)) {
                            userData.weekActivity = loaded.weekActivity;
                        }
                } catch (e) {
                    console.log('No se pudo cargar datos guardados');
                }
            }

                // Load week activity from dedicated key if present
                try {
                    const week = JSON.parse(localStorage.getItem('vocatioWeekActivity') || 'null');
                    if (Array.isArray(week) && week.length === 7) {
                        userData.weekActivity = week;
                    }
                } catch (e) {
                    console.error('Error loading week activity:', e);
                }

            // Actualizar estad√≠sticas
            document.getElementById('testsCompletados').textContent = userData.testsCompleted;
            document.getElementById('carrerasExploradas').textContent = userData.careersExplored;
            document.getElementById('materialesRevisados').textContent = (userData.materialsReviewed || 0);
            document.getElementById('progresoTotal').textContent = userData.totalProgress + '%';
            document.getElementById('barraProgreso').style.width = userData.totalProgress + '%';

            // Actualizar gr√°fica de intereses (usar .bar-fill y .percent)
            // Las barras corresponden a: Tecnolog√≠a, Ciencias, Arte, Negocios, Social
            const barras = document.querySelectorAll('.grafica-intereses .barra');
            const interestKeys = ['technology', 'science', 'art', 'business', 'social'];
            const interestLabels = ['Tecnolog√≠a', 'Ciencias', 'Arte', 'Negocios', 'Social'];
            
            barras.forEach((barra, index) => {
                const key = interestKeys[index];
                const value = Math.round(userData.interests[key] || 0);
                const fill = barra.querySelector('.bar-fill');
                const pct = barra.querySelector('.percent');
                if (fill) fill.style.height = Math.max(value, 2) + '%';
                if (pct) pct.textContent = value + '%';
            });

            // Actualizar gr√°fica semanal (persistida en userData.weekActivity)
            // Height escala seg√∫n hora del d√≠a: hora actual / 24h = % de d√≠a transcurrido
            const diasBarras = document.querySelectorAll('.grafica-semanal .barra-dia');
            const ahora = new Date();
            const horaActual = ahora.getHours() + (ahora.getMinutes() / 60);
            const porcentajeDia = (horaActual / 24) * 100; // % del d√≠a que ha pasado (0-100%)
            
            diasBarras.forEach((barra) => {
                const index = parseInt(barra.getAttribute('data-day-index') || '0', 10);
                const value = userData.weekActivity[index] || 0;
                
                // Si hay visitas: altura = porcentajeDia (hora actual)
                // Si no hay visitas: altura = 5% (m√≠nimo)
                const heightPercent = value > 0 ? porcentajeDia : 5;
                barra.style.height = Math.max(heightPercent, 5) + '%';
                const span = barra.querySelector('span');
                if (span) span.textContent = value;
            });

            // Generar actividades en vista de detalles
            renderActivities();

            // Mostrar/ocultar elementos seg√∫n si hay progreso
            const hasProgress = userData.totalProgress > 0 || userData.activities.length > 0;
            if (hasProgress) {
                document.getElementById('mensajeProgresoCero').style.display = 'none';
                document.getElementById('mensajeProgresoCeroDetalle').style.display = 'none';
            } else {
                document.getElementById('mensajeProgresoCero').style.display = 'block';
                document.getElementById('mensajeProgresoCeroDetalle').style.display = 'block';
            }
        }

        // Cargar datos al iniciar
        document.addEventListener('DOMContentLoaded', function() {
            actualizarPagina();
        });

        // Cargar datos cada vez que la p√°gina se hace visible
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                actualizarPagina();
            }
        });

        // Funci√≥n para agregar actividades (se puede llamar desde otras p√°ginas)
        window.agregarActividad = function(activityData) {
            if (!userData.activities) userData.activities = [];
            
            // activityData ejemplo: { type: 'test', name: 'Test 1', progress: 100, careerName: 'Ing. Sistemas' }
            userData.activities.push({
                ...activityData,
                timestamp: new Date().toISOString()
            });

            // Actualizar estad√≠sticas seg√∫n tipo
            switch(activityData.type) {
                case 'test':
                    // increment tests counter (persisted)
                    const prevCount = parseInt(localStorage.getItem('vocatioTestsTaken') || '0', 10);
                    const newCount = prevCount + 1;
                    localStorage.setItem('vocatioTestsTaken', String(newCount));
                    userData.testsCompleted = newCount;
                    break;
                case 'material':
                    // track reviewed materials; if careerName present, mark by career
                    if (activityData.careerName) {
                        try {
                            const key = activityData.careerName;
                            const reviewed = JSON.parse(localStorage.getItem('vocatioMaterialsReviewedByCareer') || '[]');
                            if (!reviewed.includes(key)) {
                                reviewed.push(key);
                                localStorage.setItem('vocatioMaterialsReviewedByCareer', JSON.stringify(reviewed));
                            }
                            userData.materialsReviewed = reviewed.length;
                        } catch (e) {
                            console.error('Error updating materials by career', e);
                        }
                    } else {
                        userData.materialsReviewed++;
                    }
                    break;
                case 'career':
                    userData.careersExplored++;
                    break;
            }

            // Increment weekly activity for today
            try {
                const now = new Date();
                // convert JS getDay (0=Sun) to our index Mon=0..Sun=6
                const jsDay = now.getDay();
                const dayIndex = (jsDay + 6) % 7;
                userData.weekActivity = userData.weekActivity || [0,0,0,0,0,0,0];
                userData.weekActivity[dayIndex] = (userData.weekActivity[dayIndex] || 0) + 1;
                localStorage.setItem('vocatioWeekActivity', JSON.stringify(userData.weekActivity));
            } catch (e) {
                console.error('Error updating week activity', e);
            }

            // Recalcular progreso total
            userData.totalProgress = Math.round(((userData.testsCompleted + userData.careersExplored + (userData.materialsReviewed||0)) / 30) * 100);

            // Guardar en localStorage
            localStorage.setItem('vocatioUserProgress', JSON.stringify(userData));

            // Recargar la p√°gina para mostrar cambios
            location.reload();
        };

        // Funci√≥n para incrementar progreso (se puede llamar desde otras p√°ginas)
        window.incrementarProgreso = function(type, amount = 1) {
            switch(type) {
                case 'test':
                    // update persistent tests counter
                    const prev = parseInt(localStorage.getItem('vocatioTestsTaken') || '0', 10);
                    const updated = prev + amount;
                    localStorage.setItem('vocatioTestsTaken', String(updated));
                    userData.testsCompleted = updated;
                    break;
                case 'career':
                    userData.careersExplored += amount;
                    break;
                case 'material':
                    userData.materialsReviewed += amount;
                    break;
            }
            // Calcular progreso total
            userData.totalProgress = Math.round(((userData.testsCompleted + userData.careersExplored + userData.materialsReviewed) / 30) * 100);
            // Guardar en localStorage
            localStorage.setItem('vocatioUserProgress', JSON.stringify(userData));
            // Recargar la p√°gina para mostrar cambios
            location.reload();
        };

        // Helper: registrar test completion from test page
        window.registrarTestCompletion = function(resultData) {
            // resultData optional, will be stored as last result
            try {
                const prev = parseInt(localStorage.getItem('vocatioTestsTaken') || '0', 10);
                const updated = prev + 1;
                localStorage.setItem('vocatioTestsTaken', String(updated));
                if (resultData) localStorage.setItem('vocatioTestResults', JSON.stringify(resultData));
                // also push activity
                window.agregarActividad({ type: 'test', name: resultData && resultData.name ? resultData.name : 'Test', progress: 100, careerName: (resultData && resultData.topCareer) || '' });
            } catch (e) { console.error(e); }
        };

        // Helper: mark a selected career (from explore) so materialsReviewed counts by career
        window.marcarSeleccionCarrera = function(careerKey) {
            try {
                if (!careerKey) return;
                localStorage.setItem('vocatioSelectedCareer', careerKey);
                const reviewed = JSON.parse(localStorage.getItem('vocatioMaterialsReviewedByCareer') || '[]');
                if (!reviewed.includes(careerKey)) {
                    reviewed.push(careerKey);
                    localStorage.setItem('vocatioMaterialsReviewedByCareer', JSON.stringify(reviewed));
                }
                // update materialsReviewed
                const materialsArr = JSON.parse(localStorage.getItem('vocatioMaterialsReviewed') || '[]');
                localStorage.setItem('vocatioMaterialsReviewed', JSON.stringify(materialsArr));
                // push an activity
                window.agregarActividad({ type: 'career', name: careerKey, careerName: careerKey });
            } catch (e) { console.error(e); }
        };
    </script>
